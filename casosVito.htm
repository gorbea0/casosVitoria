<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Legionelosis ¬∑ 3D + riesgos + buscadores</title>

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<style>
  html,body,#map{height:100%;margin:0}
  .panel{
    position:absolute;top:10px;left:10px;z-index:10;background:#fff;padding:10px 12px;border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.18);font:14px/1.25 system-ui,Segoe UI,Roboto,sans-serif;max-width:360px
  }
  .sec{font-weight:700;margin:.2rem 0 .4rem}
  .row{display:flex;gap:.5rem;align-items:center;margin:.35rem 0}
  .row input[type="text"]{flex:1;padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px}
  .btn{padding:6px 10px;border-radius:8px;border:1px solid #e5e7eb;background:#f3f4f6;cursor:pointer}
  .btn:hover{background:#e5e7eb}
  /* Acorde√≥n + scroll */
  #yearsWrap{max-height:45vh;overflow-y:auto;border-top:1px solid #eee;padding-top:.35rem}
  .acc-h{width:100%;display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;margin:.35rem 0 .2rem;cursor:pointer;font-weight:600}
  .acc-h .chev{transition:transform .15s ease}
  .acc-h[aria-expanded="false"] .chev{transform:rotate(-90deg)}
  .acc-b{padding:.25rem}
  .case-li{display:flex;align-items:center;gap:.4rem;margin:.12rem 0}
  .legend{position:absolute;top:10px;right:64px;z-index:10;background:#fff;padding:8px 10px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.18);font:13px}
  .tip{font-size:12px;color:#6b7280}
  
  
  
  /* Encabezado de secci√≥n colapsable */
.sec-h{
  width:100%;
  display:flex; justify-content:space-between; align-items:center;
  background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px;
  padding:8px 10px; margin:.45rem 0 .25rem; cursor:pointer; font-weight:700
}
.sec-h .chev{ transition:transform .15s ease }
.sec-h[aria-expanded="false"] .chev{ transform:rotate(-90deg) }

/* Cuerpo: se oculta/ense√±a solo con CSS seg√∫n aria-expanded */
.sec-b{ padding:.25rem 0 }
.sec-h + .sec-b{ display:block }
.sec-h[aria-expanded="false"] + .sec-b{ display:none }

</style>
</head>
<body>
<div id="map"></div>

<div class="panel">


<div class="coll">
  <button class="sec-h" id="secMapBtn" aria-expanded="true">
    <span>üó∫Ô∏è Mapa base</span><span class="chev">‚ñæ</span>
  </button>
  <div class="sec-b" id="secMapBody">
    <div class="row">
      <select id="basemap">
        <option value="osm">OSM (normal)</option>
        <option value="light">Sencillo (Carto Light)</option>
        <option value="sat">Sat√©lite (Esri)</option>
      </select>
      <button class="btn" id="fit">Encajar</button>
    </div>

    <div class="sec">üß≠ Vista 3D</div>
    <div class="row"><label style="width:6rem">Inclinaci√≥n</label><input id="pitch" type="range" min="0" max="70" value="55" style="flex:1"></div>
    <div class="row"><label style="width:6rem">Rotaci√≥n</label><input id="bearing" type="range" min="0" max="360" value="330" style="flex:1"></div>
    <div class="row"><label><input id="chkBlds" type="checkbox" checked> Edificios 3D</label></div>

    <div class="sec">üîé Buscar calle/direcci√≥n</div>
    <div class="row"><input id="q" type="text" placeholder="C/ ‚Ä¶, Vitoria"><button class="btn" id="go">Buscar</button></div>
  </div>
</div>


<div class="coll">
  <button class="sec-h" id="secRiskBtn" aria-expanded="true">
    <span>üè∑Ô∏è Puntos de riesgo</span><span class="chev">‚ñæ</span>
  </button>
  <div class="sec-b" id="secRiskBody">
    <div class="row"><label><input id="riskAll" type="checkbox" checked> Todos</label></div>
    <div class="row"><label><input id="riskFuente" type="checkbox" checked> ‚õ≤ Fuentes</label></div>
    <div class="row"><label><input id="riskLava"   type="checkbox" checked> üßΩ Lavacoches</label></div>
    <div class="row"><label><input id="riskTorre"  type="checkbox" checked> üè¢ Torres</label></div>
    <div class="row">
      <input id="riskQ" list="riskNames" type="text" placeholder="Buscar punto de riesgo‚Ä¶">
      <datalist id="riskNames"></datalist>
      <button class="btn" id="riskGo">Ir</button>
    </div>
  </div>
</div>


<div class="coll">
  <button class="sec-h" id="secCasesBtn" aria-expanded="false"> <!-- colapsada por defecto -->
    <span>‚ò†Ô∏è Casos (on/off)</span><span class="chev">‚ñæ</span>
  </button>
  <div class="sec-b" id="secCasesBody">
    <div class="row"><label><input id="chkAll" type="checkbox"> Todos los casos</label></div>
    <div class="row"><label><input id="chkLines" type="checkbox" checked> Conectar puntos</label></div>
    <div id="yearsWrap"><div id="years"></div></div>
    <div class="tip">Popup: ID ¬∑ fecha ¬∑ contagio aprox. (‚àí15 d√≠as). Radio: 400 m.</div>
  </div>
</div>


 
  
  
  
</div>

<div class="legend">Casos legionella</div>

<script>
// =================== CONFIG ===================
const BUILDINGS_URL = 'https://raw.githubusercontent.com/gorbea0/casosVitoria/main/vitoria.geojson';

// ======== Ejemplo de casos (puedes editar) =========
window.CASES_JSON = window.CASES_JSON || [
  { id:"C-101", date:"2022-08-17", coords:[[42.851,-2.681]] },
  { id:"C-102", date:"2023-09-03", coords:[[42.848,-2.676],[42.853,-2.672]] },
  { id:"C-103", date:"2022-08-17", coords:[[42.843,-2.679]] },
  { id:"C-104", date:"2023-10-05", coords:[[42.846,-2.670]] },
  { id:"C-105", date:"2024-03-19", coords:[[42.8515,-2.6740]] },
  { id:"C-106", date:"2024-05-11", coords:[[42.844,-2.668]] },
  { id:"C-107", date:"2022-11-19", coords:[[42.839,-2.674]] },
  { id:"C-108", date:"2024-03-05", coords:[[42.854,-2.666]] },
  { id:"C-109", date:"2023-07-12", coords:[[42.858,-2.686]] },
  // ejemplo multipunto con nombres:
  { id:"C-200", date:"2025-02-10", places:[
      {name:"Casa",    lat:42.857, lng:-2.68},
      {name:"Trabajo", lat:42.861, lng:-2.672},
      {name:"Paseo",   lat:42.852, lng:-2.689}
  ]},
  { id:"012507", date:"1-9-2025", coords:[[42.85734489500092,-2.679122517354255]] }
];

// ======== Puntos de riesgo  =========



	window.samplingPointjson = window.samplingPointjson || {
  "D-1001": {
    "nombre": "CC Zabalgana ACS",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-1018": {
    "nombre": "Fuente orn La Rosaleda de Arriaga",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.8606933852556, -2.681133443611]
  },
  "D-1019": {
    "nombre": "Residencia Roure ACS",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1030": {
    "nombre": "Cami√≥n cisterna limpieza",
    "tipo": "VLV",
    "subtipo": "VLV"
  },
  "D-1031": {
    "nombre": "Barredora con aerosolizaci√≥n",
    "tipo": "VLV",
    "subtipo": "VLV"
  },
  "D-1032": {
    "nombre": "Residencia Lovi",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1033": {
    "nombre": "Fuente ornamental Pza Sta Barbara grulla",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.84522965543591, -2.66672613884827]
  },
  "D-1034": {
    "nombre": "Fuente Pza Sim√≥n Bolivar",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.848548846772395, -2.66269560942619]
  },
  "D-1037": {
    "nombre": "ES Gorbea Urartea",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.86385285133459, -2.7131673398750]
  },
  "D-1038": {
    "nombre": "ES Foronda lavacoches",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.895869420260155, -2.70190084230467]
  },
  "D-1039": {
    "nombre": "Centro de dia Blas de Otero",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1040": {
    "nombre": "EI Zaramaga ACS",
    "tipo": "Escuela infantil",
    "subtipo": "ACS"
  },
  "D-1041": {
    "nombre": "Polideportivo Aranako",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-1042": {
    "nombre": "CP Santa LUCIA ACS",
    "tipo": "Escuela infantil",
    "subtipo": "ACS"
  },
  "D-1043": {
    "nombre": "Ceip Mariturri ACS",
    "tipo": "Escuela infantil",
    "subtipo": "ACS"
  },
  "D-1044": {
    "nombre": "CEIP Angel Ganivet ACS",
    "tipo": "Escuela infantil",
    "subtipo": "ACS"
  },
  "D-1045": {
    "nombre": "CEIP Aldaialde ACS",
    "tipo": "Escuela infantil",
    "subtipo": "ACS"
  },
  "D-1047": {
    "nombre": "ACS Polideportivo El Campillo",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-1048": {
    "nombre": "ACS Fronton Abetxuko",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-1054": {
    "nombre": "Hotel Jardines Uleta ACS",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-1057": {
    "nombre": "ACS Padel Jundiz",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-1058": {
    "nombre": "ACS Vivagym",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-1059": {
    "nombre": "ACS Padel norte",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-1060": {
    "nombre": "Hotel Libere",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-1061": {
    "nombre": "Residencia Aitona Urederra bi 25",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1062": {
    "nombre": "Centro Mayores S Martin AFCH",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1064": {
    "nombre": "Hotel Centro Vitoria ACS",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-1066": {
    "nombre": "Centro de Mayores San Martin ACS",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1067": {
    "nombre": "Fuente ornam Monasterio Leyre",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.86468306402665, -2.69745161280294]
  },
  "D-1068": {
    "nombre": "Lavacoches Boulevard",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.86164072247478, -2.6642590193467246]
  },
  "D-1069": {
    "nombre": "Lavacoches BP Salburua",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.8563873145512, -2.656798037682]
  },
  "D-1070": {
    "nombre": "Fuente ornamental hegoalde",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.837365773819, -2.666938703225]
  },
  "D-1071": {
    "nombre": "ES Repsol Lavacoches Vda Cantabrico 8",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.864255534882, -2.6605542376496]
  },
  "D-1072": {
    "nombre": "Olarambe futbol ACS",
    "tipo": "Campo de futbol",
    "subtipo": "ACS"
  },
  "D-1072-2": {
    "nombre": "Olaranbe campo futbol vestuarios abajo",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-1073": {
    "nombre": "Fuente ornamental Parque Este Salburua",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental"
  },
  "D-1074": {
    "nombre": "Fuente ornamental Boulevard Salburua 10",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental"
  },
  "D-1075": {
    "nombre": "Kirolclub Mendizorrotza ACS",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-1076": {
    "nombre": "Gimnasio Fitness Park Vitoria. CC Boulevard",
    "tipo": "Gimnasio",
    "subtipo": "ACS"
  },
  "D-1077": {
    "nombre": "Centro 3¬∫ edad Arana",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1079": {
    "nombre": "Lavacoches Uritiasolo venta estrella",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.837007718016, -2.65837664748707]
  },
  "D-1080": {
    "nombre": "Lavacoches Iparaguirre",
    "tipo": "Gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.836926036184, -2.65971396580518]
  },
  "D-300": {
    "nombre": "ACS Pabell√≥n Deportivo Mendizorrotza",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-301": {
    "nombre": "ACS Polideportivo Aranalde",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-302-PO": {
    "nombre": "ACS Polideportivo Abetxuko",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-302-PI": {
    "nombre": "ACS Piscinas abetxuko",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-302": {
    "nombre": "ACS Piscinas Abetxuko",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-303": {
    "nombre": "ACS Polideportivo Ariznavarra",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-304": {
    "nombre": "ACS Polideportivo Arriaga",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-305": {
    "nombre": "ACS Divino Maestro Colegio",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-306": {
    "nombre": "ACS Polideportivo Landazuri",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-307": {
    "nombre": "ACS CC Aldave",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-309": {
    "nombre": "ACS CC Hegoalde",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-310": {
    "nombre": "ACS CC Iparralde",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-311": {
    "nombre": "ACS Parque de Gamarra",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-312": {
    "nombre": "ACS CC Judizmendi",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-313": {
    "nombre": "ACS CC Lakua-Sansomendi",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-314": {
    "nombre": "ACS Fundaci√≥n Estadio",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-315": {
    "nombre": "ACS Frontones de Mendizorrotza",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-316": {
    "nombre": "ACS Polideportivo San Andr√©s",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-317": {
    "nombre": "ACS Residencia Ancianos Arcaia",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-318": {
    "nombre": "ACS Complejo Deportivo Beto√±o",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-318-1": {
    "nombre": "Beto√±o Campo de futbol ACS",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-318-2": {
    "nombre": "Beto√±o vestuarios nuevos",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-318-3": {
    "nombre": "Beto√±o aranako",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-319": {
    "nombre": "ACS Piscinas de Mendizorrotza",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-320": {
    "nombre": "ACS Residencia Ajuria",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-321": {
    "nombre": "ACS Residencia Hermanitas de los Pobres",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-322": {
    "nombre": "ACS Residencia Juan Pablo I",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-323": {
    "nombre": "ACS Residencia Arana",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-324": {
    "nombre": "ACS Residencia Etxebidea",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-325": {
    "nombre": "ACS Residencia San Prudencio",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-326": {
    "nombre": "ACS Residencia Quavitae Ariznavarra",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-328": {
    "nombre": "ACS Residencia Txagorritxu",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-329": {
    "nombre": "ACS Residencia Metroces",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-331": {
    "nombre": "ACS Hotel Ciudad de Vitoria",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-332": {
    "nombre": "ACS Hotel Gran H Lakua",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-333": {
    "nombre": "ACS Hotel Gobeo Park",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-334": {
    "nombre": "ACS Hotel General Alava",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-335": {
    "nombre": "ACS Hotel Ruta de Europa",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-336": {
    "nombre": "ACS Residencia Aurora",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-337": {
    "nombre": "ACS Residencia Los Arquillos",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-338": {
    "nombre": "Torre Centro Comercial Boulevard",
    "tipo": "Centro comercial",
    "subtipo": "Torre",
	"coords": [42.861657250, -2.6675392237]
	
  },
  "D-341": {
    "nombre": "Torre Quavitae Residencia",
    "tipo": "Residencia",
    "subtipo": "Torre",
	"coords": [42.839848710, -2.6955310886]
	},
  "D-352": {
    "nombre": "Torre Dendaraba",
    "tipo": "Centro comercial",
    "subtipo": "Torre",
	"coords": [42.84506716339, -2.66844821933],
	"email":"h@hidrocontrol.net"
  },
  "D-353": {
    "nombre": "Torre Centro Comercial Lakua",
    "tipo": "Centro comercial",
    "subtipo": "Torre"
  },
  "D-359": {
    "nombre": "Torre El Corte Ingles",
    "tipo": "Centro comercial",
    "subtipo": "Torre",
	"coords": [42.84481312339, -2.667879550615]
  },
  "D-361": {
    "nombre": "Torre Edificio Opera",
    "tipo": "Centro comercial",
    "subtipo": "Torre",
	"coords":[42.844118976004, -2.67049272406319],
	"email":"sonia_lacuesta@hotmail.com"
  },
  "D-363": {
    "nombre": "Torre EDAR de Crispijana",
    "tipo": "Varios",
    "subtipo": "Torre",
	"coords":[42.853361372348644, -2.741892889055],
	"email":"raul.cerezo@dam-aguas.es"
  },
  "D-365": {
    "nombre": "ACS Residencia los Molinos",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-366": {
    "nombre": "ACS Hotel Almoneda",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-367": {
    "nombre": "ACS Hotel Amarica",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-368": {
    "nombre": "ACS Hotel Barrachi",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-369": {
    "nombre": "ACS Hotel Boulevard",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-370": {
    "nombre": "ACS Hotel Canciller Ayala",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-371": {
    "nombre": "ACS Hotel Dato",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-372": {
    "nombre": "ACS Hotel Desiderio",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-373": {
    "nombre": "ACS Hotel Duque de Wellington",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-374": {
    "nombre": "ACS Hotel El Caser√≥n",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-375": {
    "nombre": "ACS CCIbaiondo",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-376": {
    "nombre": "ACS Hotel Gorbea",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-377": {
    "nombre": "ACS Hotel Holiday Inn Express",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-378": {
    "nombre": "ACS Hotel Iradier",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-379": {
    "nombre": "ACS Hotel La Bilba√≠na",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-380": {
    "nombre": "ACS Hotel La Zuyana",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-381": {
    "nombre": "ACS Hotel Palacio de Elorriaga",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-382": {
    "nombre": "ACS Atlas",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-382-1": {
    "nombre": "Atlas ACS circuito balneario",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-382-2": {
    "nombre": "Atlas ACS circuito sala botiquin",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-382-3": {
    "nombre": "Atlas ACS circuito gimnasio",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-383": {
    "nombre": "ACS Pensi√≥n Casa 400",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-384": {
    "nombre": "ACS Hotel Achuri",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-386": {
    "nombre": "ACS Hydra Boulevard",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-387": {
    "nombre": "ACS Gimnasio K2",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-389": {
    "nombre": "ACS La Pe√±a Vitoriana",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-392": {
    "nombre": "ACS Bakh",
    "tipo": "Polideportivo privado",
    "subtipo": "ACS"
  },
  "D-394": {
    "nombre": "ACS Piscinas Olabide",
    "tipo": "Centro educativo",
    "subtipo": "ACS"
  },
  "D-395": {
    "nombre": "ACS Residencia Colisee Mi√±ano",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-396": {
    "nombre": "ACS Residencia Ari√±ez",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-397": {
    "nombre": "ACS Residencia Otazu",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-398": {
    "nombre": "ACS Residencia Lakua DFA",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-399": {
    "nombre": "ACS Residencia Abetxuko",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-900": {
    "nombre": "Riego Zumabide Aretxabaleta",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-901": {
    "nombre": "Riego Maria Maeztu",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-904": {
    "nombre": "Riego San Martin Bustinzuri",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-905": {
    "nombre": "Riego San Martin interior",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-906": {
    "nombre": "Riego San Martin Lago",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-907": {
    "nombre": "Riego Arana",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-908": {
    "nombre": "Riego Etxezarra",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-909": {
    "nombre": "Riego Lakuabizkarra",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-910": {
    "nombre": "Fte or Cuadrilla Vitoria",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.8581858242208, -2.6684876878667]
  },
  "D-911": {
    "nombre": "Fte or Parque Norte",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.852662092203, -2.67027008323399]
  },
  "D-912": {
    "nombre": "Fte or Constituci√≥n",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.85499170500697, -2.679168580942587]
  },
  "D-914": {
    "nombre": "Fte or Gazalbide",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.85615851107105, -2.68620833474453]
  },
  "D-915": {
    "nombre": "Fte or Iparralde",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.854741614836, -2.6673658089155]
  },
  "D-916": {
    "nombre": "Fte or Galeon Lakua",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.8621433816209, -2.6967101023928]
  },
  "D-917": {
    "nombre": "Fte or Juzgados",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.84436406402089, -2.68212915304183]
  },
  "D-918": {
    "nombre": "Fte or Resid San Prudencio",
    "tipo": "residencia",
    "subtipo": "Fuente ornamental"
  },
  "D-919": {
    "nombre": "ACS Hotel Catedral",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-920": {
    "nombre": "ACS Residencia Elorri ACS",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-921": {
    "nombre": "Riego Molinuevo",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-922": {
    "nombre": "Fachada vegetal Europa",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-953": {
    "nombre": "ACS Residencia Aitona Etxea",
    "tipo": "residencia",
    "subtipo": "ACS"
  },
  "D-958": {
    "nombre": "ACS Restaurante La Brasa",
    "tipo": "bar",
    "subtipo": "ACS"
  },
  "D-959": {
    "nombre": "Lavacoches Elefante Azul",
    "tipo": "Lavacoches",
    "subtipo": "lavacoches",
	"coords":[42.83677872126, -2.6992571823933]
  },
  "D-960": {
    "nombre": "Fuente orn Juan Pablo I",
    "tipo": "residencia",
    "subtipo": "Fuente ornamental"
  },
  "D-966": {
    "nombre": "ACS Centro acogida social municipal",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-976": {
    "nombre": "Riego Aranbizkarra",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-977": {
    "nombre": "ACS CC Salburua ACS",
    "tipo": "polideportivo",
    "subtipo": "ACS"
  },
  "D-978": {
    "nombre": "Riego Salburua",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-979": {
    "nombre": "Riego parque Zabalgana",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-980": {
    "nombre": "Riego parque Arriaga",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-981": {
    "nombre": "Riego parque el Prado",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-982": {
    "nombre": "Riego Judimendi",
    "tipo": "Varios",
    "subtipo": "Riego"
  },
  "D-983": {
    "nombre": "Geiser parque Arriaga",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.86288520850176, -2.6777551121044],
	"email":"paisajeurbano@vitoria-gasteiz.org"
  },
  "D-987": {
    "nombre": "Lavacoches Repsol Trianas",
    "tipo": "gasolinera",
    "subtipo": "lavacoches",
	"coords":[42.83972316552165, -2.66237339976354]
  },
  "D-988": {
    "nombre": "ACS Frontones Lakua 03 ACS",
    "tipo": "Frontones",
    "subtipo": "ACS"
  },
  "D-999": {
    "nombre": "Fuente orn El Cocodrilo",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.84518192095005, -2.67831813897868]
  },
  "LEGIO-000": {
    "nombre": "no programada legio",
    "tipo": "Varios",
  },
  "D-1090": {
    "nombre": "RESIDENCIA AGURE - ZABALGANA",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1104": {
    "nombre": "Residencia Ascarza",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1087": {
    "nombre": "RESIDENCIA LAKUA",
    "tipo": "Residencia",
    "subtipo": "AFCH Grifo"
  },
  "D-1105": {
    "nombre": "Residencia Hogar Alav√©s",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1022": {
    "nombre": "RESIDENCIA SAN IGNACIO",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1095": {
    "nombre": "RESIDENCIA TAGORE",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1136": {
    "nombre": "RESIDENCIA PALACIO DE LA BURULLERIA",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1109": {
    "nombre": "Residencia Aiara",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1097": {
    "nombre": "RESIDENCIA ALBERTIA CAMPUS",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1110": {
    "nombre": "Residencia geri√°trica El Pilar",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1096": {
    "nombre": "Residencia Mercedarias Egoitza",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1088": {
    "nombre": "Apparthotel passivhaus Kora Green City",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-1141": {
    "nombre": "Apartamentos Irenaz",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-1082": {
    "nombre": "Lavacoches Onaindia Ptal Arriaga 66",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords":[42.86882172453038, -2.67851617247947]
  },
  "D-1107": {
    "nombre": "Lavacoches Ibaia Energy",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords":[42.829366137115, -2.7227249333878]
  },
  "D-1108": {
    "nombre": "Lavacoches Ballenoil",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords":[42.836060284500, -2.70185318956172]
  },
  "D-319-1": {
    "nombre": "Edificio social Mendizorrotza",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-1081": {
    "nombre": "Lavacoches lowcost venta estrella",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords":[42.83729173193958, -2.65792664393718]
  },
  "D-313-1": {
    "nombre": "Polidep Lakua03 zona izd",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-313-2": {
    "nombre": "Polidep Lakua 03 zona dcha",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-313-3": {
    "nombre": "Polidep Lakua 03 campo futbol",
    "tipo": "Polideportivo",
    "subtipo": "ACS"
  },
  "D-1083": {
    "nombre": "Lavacoches CEPSA Dusseldorf",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords":[42.852082855295, -2.71001174572264]
  },
  "D-1084": {
    "nombre": "Fuente ornamental Deva",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.858453792584, -2.662314836460]
  },
  "D-1085": {
    "nombre": "Lavacoches Ballenoil Adurza Vitoria2",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords":[42.8341511384322, -2.66603482397103]
  },
  "D-1091": {
    "nombre": "Apartamentos Dreampark",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1089": {
    "nombre": "SYNERGYM BORINBIZKARRA",
    "tipo": "Gimnasio",
    "subtipo": "ACS"
  },
  "D-1086": {
    "nombre": "HOTEL IBIS BUDGET",
    "tipo": "Hotel",
    "subtipo": "ACS"
  },
  "D-1092": {
    "nombre": "Fuente ornamental Abenda√±o",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.846077309158, -2.6835335561616]
  },
  "D-1093": {
    "nombre": "Fuente ornamental Juan de Ayala",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1094 ": {
    "nombre": "Fuente ornamental edificio Aqua Salburua",
    "tipo": "Fuente ornamental",
    "subtipo": "Fuente ornamental",
	"coords":[42.853649228732, -2.64932601207691]
  },
  "D-1098": {
    "nombre": "Residencia Senda Corazonistas",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1099": {
    "nombre": "Campo de Futbol Adurza",
    "tipo": "Campo de futbol",
    "subtipo": "Aspersores"
  },
  "D-1100": {
    "nombre": "Campo de futbol Adurzabal",
    "tipo": "Campo de futbol",
    "subtipo": "Aspersores"
  },
  "D-1101": {
    "nombre": "Residencia Albertia Iradier",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1102": {
    "nombre": "Residencia Egoitza",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1103": {
    "nombre": "Residencia Goizalde",
    "tipo": "Residencia",
    "subtipo": "ACS"
  },
  "D-1106": {
    "nombre": "Residencia IMQ-Igurco",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1111": {
    "nombre": "Go Gym",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1112": {
    "nombre": "Fitness Gasteiz (Energy Fitness)",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1113": {
    "nombre": "Gimnasio Gasteiz Sport",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1114": {
    "nombre": "Alta Fit Los Herr√°n",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1115 ": {
    "nombre": "Dreamfit Vitoria",
    "tipo": "Gimnasio",
    "subtipo": "ACS"
  },
  "D-1116": {
    "nombre": "Gimnasio Yin-Yang",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1117": {
    "nombre": "Gimnasio Rodas",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1118": {
    "nombre": "Campo de futbol La Vitoriana 01 (cementario)",
    "tipo": "Legio Riego",
    "subtipo": "Riego"
  },
  "D-1119": {
    "nombre": "Campo de futbol La Vitoriana 2",
    "tipo": "Legio Riego",
    "subtipo": "Riego"
  },
  "D-1120": {
    "nombre": "Campo de futbol Zaramaga",
    "tipo": "Legio Riego",
    "subtipo": "Riego"
  },
  "D-390": {
    "nombre": "Polideportivo Land√°zuri (ACS)",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-391": {
    "nombre": "C.C.el Pilar",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-393": {
    "nombre": "ACS Atlas",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-385": {
    "nombre": "Pensi√≥n Arriaga",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-341-2": {
    "nombre": "Quavitae, C/Teodoro G Zarate 14",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-341-1": {
    "nombre": "Quavitae, C/Teodoro G Zarate 14",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-360-1": {
    "nombre": "Hotel Barcelo, Avenida Gasteiz 45",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-361-2": {
    "nombre": "Hotel Barcelo, Avenida Gasteiz 45",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-360-2": {
    "nombre": "Hotel Barcelo, Avenida Gasteiz 45",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-362-1": {
    "nombre": "Gran Hotel Lakua, Tarragona, 8",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-362-2": {
    "nombre": "Gran Hotel Lakua, Tarragona, 8",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-263": {
    "nombre": "RESIDENCIA LOS ARQUILLOS: Paseo de los Arquillos 11 bajo",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-364": {
    "nombre": "Casa de Duchas C/ Correria 106",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-330": {
    "nombre": "BARCELO HOTEL GASTEIZ, Avenida de Gasteiz, 45",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-302-POLI": {
    "nombre": "Polideportivo Abetxuko ACS",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-319-LUD": {
    "nombre": "Piscinas Mendizorrotza ACS",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-319-SOC": {
    "nombre": "Mendizorrotza Centro Social ACS",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-10047": {
    "nombre": "ACS Polideportivo El Campillo",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-314-2": {
    "nombre": "ESTADIO SD Trinkete ACS",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1115": {
    "nombre": "Dreamfit Vitoria",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1121": {
    "nombre": "Lavacoches Shell Beto√±o",
    "tipo": "Lavacoches",
    "subtipo": "Lavacoches",
	"coords": [42.86474837988303, -2.653187043598311]
  },
  "D-1023": {
    "nombre": "ACS Residencia Erantsi",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1124": {
    "nombre": "Lavacoches ES Repsol Portal de Gamarra",
    "tipo": "Legio VLH",
    "subtipo": "Lavacoches",
	"coords": [42.86426268488, -2.66058702907]
  },
  "D-1125": {
    "nombre": "Lavacoches ONA Low cost Portal de Gamarra",
    "tipo": "Legio VLH",
    "subtipo": "Lavacoches",
	"coords":[42.87280547067821, -2.659219718797]
  },
  "D-1126": {
    "nombre": "Synergym San Martin",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1127": {
    "nombre": "Synergym Lakua",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1128": {
    "nombre": "Synergym Zaramaga",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1129": {
    "nombre": "Synergym Arana",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1130": {
    "nombre": "Basic Fit Portal de Arriaga",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1131": {
    "nombre": "Alta Fit Guridi",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1132": {
    "nombre": "Cross fit Arana",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1134": {
    "nombre": "Residencia Lorea Txago",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1135": {
    "nombre": "Residencia Carema",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1133": {
    "nombre": "Fuente ornamental 8 marzo",
    "tipo": "Legio FOR",
    "subtipo": "Fuente ornamental",
	"coords":[42.85413331954953, -2.649010004079625]
  },
  "D-1138": {
    "nombre": "Hotel Eire",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1142": {
    "nombre": "Apartamentos Divan",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1139": {
    "nombre": "Aparthotel Jardines de Arizti",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  },
  "D-1140": {
    "nombre": "Hotel Limehome",
    "tipo": "Legio ACS",
    "subtipo": "ACS"
  }
}















// ========== Helpers fecha (sin UTC) ==========
function keyFromAnyDate(v){ if(!v) return null; const s=String(v).trim();
  let m=s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m) return `${m[1]}-${m[2]}-${m[3]}`;
  m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/); if(m){ const dd=m[1].padStart(2,'0'),mm=m[2].padStart(2,'0'); const yyyy=m[3].length===2?(parseInt(m[3],10)>=70?'19'+m[3]:'20'+m[3]):m[3]; return `${yyyy}-${mm}-${dd}`;}
  return null;
}
function addDaysISO(iso,n){ const [y,m,d]=iso.split('-').map(Number); const dt=new Date(y,m-1,d); dt.setDate(dt.getDate()+n); const yy=dt.getFullYear(),mm=String(dt.getMonth()+1).padStart(2,'0'),dd=String(dt.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`;}
function fmtDMY(iso){ const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(iso||''); return m?`${m[3]}-${m[2]}-${m[1]}`:iso; }

// ========= Normaliza casos (soporta coords[] o places[]) =========
const CASES = (window.CASES_JSON||[]).map(c=>{
  const iso = keyFromAnyDate(c.date); if(!iso) return null;
  const pts = [];
  if (Array.isArray(c.places)) {
    c.places.forEach((p,i)=>{
      const la = (p && (p.lat ?? (p.coords && p.coords[0]))), ln = (p && (p.lng ?? (p.coords && p.coords[1])));
      if (typeof la==='number' && typeof ln==='number') pts.push({ ll:[ln,la], label: (p.name||p.type||`P${i+1}`) });
    });
  }
  if (!pts.length && Array.isArray(c.coords)) {
    c.coords.forEach(([la,ln],i)=> pts.push({ ll:[ln,la], label:null }));
  }
  return {
    id: String(c.id).startsWith('C-')?String(c.id):`C-${c.id}`,
    iso, year:+iso.slice(0,4), dmy:fmtDMY(iso), contagioDMY:fmtDMY(addDaysISO(iso,-15)),
    points: pts
  };
}).filter(Boolean);

// ========= MapLibre base =========
const map = new maplibregl.Map({
  container:'map',
  style:{
    version:8,
     glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf", /* necesario para labels */
    sources:{
      osm:   {type:'raster', tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize:256, maxzoom:19},
      light: {type:'raster', tiles:['https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png'], tileSize:256, maxzoom:19},
      esri:  {type:'raster', tiles:['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize:256, maxzoom:19}
    },
    layers:[
      {id:'osm',type:'raster',source:'osm',layout:{visibility:'visible'}},
      {id:'light',type:'raster',source:'light',layout:{visibility:'none'}},
      {id:'esri',type:'raster',source:'esri',layout:{visibility:'none'}}
    ]
  },
  center:[-2.675,42.846], zoom:16.8, pitch:55, bearing:330
});
map.addControl(new maplibregl.NavigationControl({visualizePitch:true}), 'top-right');
map.addControl(new maplibregl.ScaleControl({maxWidth:120,unit:'metric'}), 'bottom-left');

// ==== Estado global para casos y riesgo ====
const casesBounds = new maplibregl.LngLatBounds();
const CASE_STORE = new Map(); // id -> {markers:[], circles:[ids], lineId?}
const YEAR_INDEX = new Map();
let riskIndex = []; // [{name, cat, ll}]

// ==== Carga de edificios + casos + riesgo ====
map.on('load', async ()=>{
  // Edificios 3D
  map.addSource('buildings',{type:'geojson', data:BUILDINGS_URL});
  map.addLayer({
    id:'buildings-3d', type:'fill-extrusion', source:'buildings',
    paint:{
      'fill-extrusion-color':'#a7b6c9','fill-extrusion-opacity':0.85,
      'fill-extrusion-height':[
        'coalesce',['to-number',['get','height']],
        ['*',['to-number',['get','building:levels']],3.2],
        10
      ]
    }
  });

  // Casos
  const skullEl = (size=24)=>{ const d=document.createElement('div'); d.style.fontSize=size+'px'; d.textContent='‚ò†Ô∏è'; d.style.filter='drop-shadow(0 1px 2px rgba(0,0,0,.4))'; return d; };
  CASES.forEach(c=>{
    const ids = { markers:[], circles:[], lineId:null };
    const pts = c.points;

    pts.forEach((p,idx)=>{
      const popup = `<b>${c.id}</b><br>${p.label?`${p.label}<br>`:''}
                     Caso: ${c.dmy}<br>Contagio aprox.: ${c.contagioDMY}
                     ${pts.length>1?`<br>Punto ${idx+1}/${pts.length}`:''}`;
      const mk = new maplibregl.Marker({element:skullEl()})
        .setLngLat(p.ll)
        .setPopup(new maplibregl.Popup({offset:14}).setHTML(popup))
        .addTo(map);
      ids.markers.push(mk);
      casesBounds.extend(p.ll);

      const circ = circlePolygon(p.ll,400,64), cid=`circle-${c.id}-${idx}`;
      map.addSource(cid,{type:'geojson',data:circ});
      map.addLayer({id:cid,type:'fill',source:cid,paint:{'fill-color':'#f59e0b','fill-opacity':.16}});
      map.addLayer({id:cid+'-s',type:'line',source:cid,paint:{'line-color':'#b45309','line-width':2,'line-opacity':.4}});
      ids.circles.push(cid,cid+'-s');
    });

    if (pts.length>1){
      const lid=`line-${c.id}`;
      map.addSource(lid,{type:'geojson',data:{type:'Feature',geometry:{type:'LineString',coordinates:pts.map(p=>p.ll)}}});
      map.addLayer({id:lid,type:'line',source:lid,paint:{'line-color':'#cc3300','line-width':3,'line-opacity':0.7,'line-dasharray':[6,4]}});
      ids.lineId = lid;
    }

    CASE_STORE.set(c.id, ids);
    (YEAR_INDEX.get(c.year) || YEAR_INDEX.set(c.year,[]).get(c.year)).push(c.id);
  });

  if (!casesBounds.isEmpty()) map.fitBounds(casesBounds,{padding:30});

  // Riesgo
  initRiskLayers(); // crea fuente + capas + wiring checkboxes + datalist

  // UI casos
  buildCasesUI();
});

// ====== UI base + 3D + buscadores ======
document.getElementById('basemap').addEventListener('change',e=>{
  const v=e.target.value;
  map.setLayoutProperty('osm','visibility',v==='osm'?'visible':'none');
  map.setLayoutProperty('light','visibility',v==='light'?'visible':'none');
  map.setLayoutProperty('esri','visibility',v==='sat'?'visible':'none');
});
document.getElementById('pitch').addEventListener('input',e=> map.setPitch(+e.target.value));
document.getElementById('bearing').addEventListener('input',e=> map.setBearing(+e.target.value));
document.getElementById('chkBlds').addEventListener('change',e=>{
  map.setLayoutProperty('buildings-3d','visibility', e.target.checked?'visible':'none');
});
document.getElementById('fit').onclick = ()=>{ if(!casesBounds.isEmpty()) map.fitBounds(casesBounds,{padding:30}); };

// Buscador de calles
async function geocode(q){
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/search?format=geojson&limit=1&q=${encodeURIComponent(q)}`,{headers:{'Accept-Language':'es'}});
    const g=await r.json(); if (g.features?.length) return g.features[0];
  }catch(_){}
  try{
    const r=await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(q)}&limit=1`);
    const g=await r.json(); if (g.features?.length) return g.features[0];
  }catch(_){}
  return null;
}
async function doSearch(){
  const q=document.getElementById('q').value.trim(); if(!q) return;
  const f=await geocode(q); if(!f) return alert('No encontrado');
  if (f.bbox?.length===4){ const [minx,miny,maxx,maxy]=f.bbox; map.fitBounds([[minx,miny],[maxx,maxy]],{padding:40}); }
  else if (f.properties?.boundingbox){ const [south,north,west,east]=f.properties.boundingbox.map(parseFloat); map.fitBounds([[west,south],[east,north]],{padding:40}); }
  else { const [lng,lat]=f.geometry.coordinates; map.flyTo({center:[lng,lat],zoom:17,speed:.6}); }
}
document.getElementById('go').onclick = doSearch;
document.getElementById('q').addEventListener('keydown',e=>{ if(e.key==='Enter') doSearch(); });

// Buscador de riesgo (por nombre)
document.getElementById('riskGo').onclick = searchRisk;
document.getElementById('riskQ').addEventListener('keydown',e=>{ if(e.key==='Enter') searchRisk(); });
function searchRisk(){
  const q=document.getElementById('riskQ').value.trim().toLowerCase();
  if (!q) return;
  const matches = riskIndex.filter(r => r.name.toLowerCase().includes(q));
  if (!matches.length) { alert('No encontrado'); return; }
  const r = matches[0];
  map.flyTo({ center:r.ll, zoom:18, speed:0.6 });
  new maplibregl.Popup({offset:12})
    .setLngLat(r.ll)
    .setHTML(`${catEmoji(r.cat)} <b>${r.name}</b><br>${catLabel(r.cat)}`)
    .addTo(map);
}

// ====== Filtros por a√±o / caso (acorde√≥n + master + l√≠neas) ======
function setCaseVisible(caseId, on){
  const e=CASE_STORE.get(caseId); if(!e) return;
  e.markers.forEach(m=> m.getElement().style.display = on?'':'none');
  (e.circles||[]).forEach(id=>{ if(map.getLayer(id)) map.setLayoutProperty(id,'visibility',on?'visible':'none'); });
  if (e.lineId && map.getLayer(e.lineId)) map.setLayoutProperty(e.lineId,'visibility',
      document.getElementById('chkLines').checked && on ? 'visible':'none');
}
function setYearVisible(year,on){
  (YEAR_INDEX.get(year)||[]).forEach(id=>{
    setCaseVisible(id,on);
    const cb=document.getElementById(`case_${year}_${cssSafe(id)}`); if(cb) cb.checked=on;
  });
  const ycb=document.getElementById(`year_${year}`); if(ycb) ycb.checked=on;
  syncMaster();
}
function cssSafe(s){ return String(s).replace(/[^a-z0-9_-]/ig,'_'); }

function buildCasesUI(){
  const yearsBox  = document.getElementById('years');
  const years     = Array.from(YEAR_INDEX.keys()).sort((a,b)=>b-a);
  const latest    = years[0];

  // master
  const master=document.getElementById('chkAll');
  master.checked=false;
  master.onchange=()=>{
    const on = master.checked;
    years.forEach(y=>{
      setYearVisible(y,on);
      const ycb=document.getElementById(`year_${y}`); if (ycb) ycb.checked=on;
      (YEAR_INDEX.get(y)||[]).forEach(id=>{
        const cb=document.getElementById(`case_${y}_${cssSafe(id)}`); if(cb) cb.checked=on;
      });
    });
  };

  yearsBox.innerHTML='';

  years.forEach(y=>{
    const sec = document.createElement('div');

    const open = (y===latest);
    const h = document.createElement('button');
    h.className='acc-h';
    h.setAttribute('aria-expanded', String(open));
    h.innerHTML=`<span>${y}</span><span class="chev">‚ñæ</span>`;
    sec.appendChild(h);

    const b = document.createElement('div');
    b.className='acc-b';
    b.style.display = open ? 'block' : 'none';

    // checkbox del a√±o
    const yearRow=document.createElement('div');
    yearRow.className='case-li';
    yearRow.innerHTML=`<input id="year_${y}" type="checkbox" ${open?'checked':''}>
                       <label for="year_${y}"><b>Todo ${y}</b></label>`;
    b.appendChild(yearRow);

    setTimeout(()=>{ const ycb=document.getElementById(`year_${y}`); ycb.onchange=e=>setYearVisible(y,e.target.checked); },0);

    // Casos individuales
    const ids=(YEAR_INDEX.get(y)||[]).slice().sort((a,b)=> a.localeCompare(b));
    ids.forEach(id=>{
      const c=CASES.find(x=>x.id===id); const safe=cssSafe(id);
      const row=document.createElement('div');
      row.className='case-li';
      row.innerHTML=`<input id="case_${y}_${safe}" type="checkbox" ${open?'checked':''}>
                     <label for="case_${y}_${safe}">${fmtDMY(c.iso)} ¬∑ ${id}</label>`;
      b.appendChild(row);

      setTimeout(()=>{ const cb=document.getElementById(`case_${y}_${safe}`); cb.onchange=e=>setCaseVisible(id,e.target.checked); setCaseVisible(id,open); },0);
    });

    // toggle acorde√≥n
    h.onclick=()=>{ const ex=h.getAttribute('aria-expanded')==='true'; h.setAttribute('aria-expanded',String(!ex)); b.style.display=ex?'none':'block'; };

    sec.appendChild(b);
    yearsBox.appendChild(sec);
  });

  syncMaster();

  // Toggle de l√≠neas
  document.getElementById('chkLines').onchange = ()=>{
    CASE_STORE.forEach(e=>{
      if (e.lineId && map.getLayer(e.lineId)) {
        const on = document.getElementById('chkLines').checked;
        const vis = on ? 'visible' : 'none';
        map.setLayoutProperty(e.lineId, 'visibility', vis);
      }
    });
  };
}
function syncMaster(){
  const years=Array.from(YEAR_INDEX.keys());
  const on=years.every(y=> (YEAR_INDEX.get(y)||[]).every(id=>{
    const cb=document.getElementById(`case_${y}_${cssSafe(id)}`); return cb && cb.checked;
  }));
  document.getElementById('chkAll').checked = on;
}





// ====== Puntos de riesgo: capas + buscador ======
function catEmoji(cat){ return cat==='fuentes'?'‚õ≤':(cat==='lavacoches'?'üßΩ':'üè¢'); }
function catLabel(cat){ return cat==='fuentes'?'Fuente ornamental':(cat==='lavacoches'?'Lavacoches':'Torre'); }

function riskFeatures(activeCats){
  const feats=[];
  for (const [id,p] of Object.entries(window.samplingPointjson||{})){
    if (!Array.isArray(p.coords)) continue;
    const ll=[p.coords[1],p.coords[0]];
    const t=((p.tipo||p.subtipo||'')+' '+(p.nombre||'')).toLowerCase();
    const cat = t.includes('fuente') ? 'fuentes' :
                t.includes('lava')   ? 'lavacoches' :
                t.includes('torre')  ? 'torres' : null;
    if (!cat || !activeCats.has(cat)) continue;
    feats.push({ type:'Feature', properties:{ name:(p.nombre||id), cat }, geometry:{ type:'Point', coordinates: ll } });
  }
  return { type:'FeatureCollection', features:feats };
}
function populateRiskIndexAndDatalist(fc){
  riskIndex = fc.features.map(f=>({ name:f.properties.name, cat:f.properties.cat, ll:f.geometry.coordinates }));
  const dl = document.getElementById('riskNames');
  dl.innerHTML = '';
  // primeras 300 sugerencias para no saturar el DOM
  riskIndex.slice(0,300).forEach(r=>{
    const opt=document.createElement('option'); opt.value=r.name; dl.appendChild(opt);
  });
}


function initRiskLayers(){
  // 1) datos iniciales (tres categor√≠as activas)
  const cats = new Set(['fuentes','lavacoches','torres']);
  const fc   = riskFeatures(cats);

  // 2) elimina capas si existen, y SOLO DESPU√âS elimina la source
  ['risk-names', 'risk-icons'].forEach(id => { if (map.getLayer(id)) map.removeLayer(id); });
  if (map.getSource('risk')) map.removeSource('risk');

  // 3) crea la source
  map.addSource('risk', { type:'geojson', data: fc });

  // 4) registrar im√°genes (canvas -> ImageData), solo si no est√°n
  function makeIconImageData(letter, fill){
    const size = 64, r = 26;
    const c = document.createElement('canvas'); c.width=size; c.height=size;
    const ctx = c.getContext('2d');
    ctx.shadowColor='rgba(0,0,0,0.35)'; ctx.shadowBlur=3; ctx.shadowOffsetY=2;
    ctx.beginPath(); ctx.arc(size/2, size/2, r, 0, Math.PI*2);
    ctx.fillStyle = fill; ctx.fill();
    ctx.lineWidth=3; ctx.strokeStyle='#fff'; ctx.stroke();
    ctx.shadowColor='transparent';
    ctx.font='700 22px system-ui, Segoe UI, Roboto, Arial';
    ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(letter, size/2, size/2 + 1);
    const img = ctx.getImageData(0,0,size,size);
    return { width: img.width, height: img.height, data: img.data };
  }
  if (!map.hasImage('ico-fuente')) map.addImage('ico-fuente', makeIconImageData('F','#2563eb'));
  if (!map.hasImage('ico-lava'))   map.addImage('ico-lava',   makeIconImageData('L','#d97706'));
  if (!map.hasImage('ico-torre'))  map.addImage('ico-torre',  makeIconImageData('T','#059669'));

  // 5) a√±ade capas (icono + nombre). Icono siempre visible; texto sin colisiones.
  map.addLayer({
    id:'risk-icons',
    type:'symbol',
    source:'risk',
    layout:{
      'icon-image': ['match',['get','cat'],
        'fuentes','ico-fuente',
        'lavacoches','ico-lava',
        'torres','ico-torre',
        'ico-fuente'
      ],
      // tama√±o por zoom; sube los valores si quieres m√°s grande
      'icon-size': ['interpolate',['linear'],['zoom'], 12,0.9, 15,1.2, 18,1.8],
      'icon-allow-overlap': true,
      'icon-ignore-placement': true
    }
  });

  const riskColor = ['match',['get','cat'],
    'fuentes','#2563eb','lavacoches','#d97706','torres','#059669','#374151'
  ];
  map.addLayer({
    id:'risk-names',
    type:'symbol',
    source:'risk',
    layout:{
      'text-field':['get','name'],
      'text-size': 13,
      'text-offset':[0,1.1],
      'text-anchor':'top',
      'text-allow-overlap': true,          // ‚¨Ö para que NO desaparezca
      'text-ignore-placement': true
    },
    paint:{
      'text-color': riskColor,
      'text-halo-color':'rgba(255,255,255,0.95)',
      'text-halo-width': 1.4
    }
  });

  // 6) rellenar buscador de riesgo
  populateRiskIndexAndDatalist(fc);

  // 7) wiring de checkboxes: ahora solo actualizamos la source (no rea√±adimos capas)
  const all = document.getElementById('riskAll');
  const cbs = {
    'fuentes':     document.getElementById('riskFuente'),
    'lavacoches':  document.getElementById('riskLava'),
    'torres':      document.getElementById('riskTorre')
  };
  const currentCats = ()=>{ const s=new Set(); for (const k in cbs){ if (cbs[k].checked) s.add(k); } return s; };
  const refreshAll  = ()=>{ all.checked = cbs.fuentes.checked && cbs.lavacoches.checked && cbs.torres.checked; };
  const update = ()=>{
    const fc = riskFeatures(currentCats());
    map.getSource('risk').setData(fc);       // ‚¨ÖÔ∏è no toca capas ‚Üí no hay ‚Äúalready exists‚Äù
    populateRiskIndexAndDatalist(fc);
    refreshAll();
  };
  all.onchange = ()=>{ const on=all.checked; for (const k in cbs) cbs[k].checked=on; update(); };
  for (const k in cbs) cbs[k].onchange = update;
  refreshAll();
}



/* ===== c√≠rculo como pol√≠gono ===== */
function circlePolygon(centerLngLat, radiusMeters, steps=64){
  const [lng,lat]=centerLngLat, R=6378137, d=radiusMeters/R, latR=lat*Math.PI/180, ring=[];
  for(let i=0;i<=steps;i++){
    const br=2*Math.PI*i/steps;
    const lat2=Math.asin(Math.sin(latR)*Math.cos(d)+Math.cos(latR)*Math.sin(d)*Math.cos(br));
    const lng2=(lng*Math.PI/180)+Math.atan2(Math.sin(br)*Math.sin(d)*Math.cos(latR),Math.cos(d)-Math.sin(latR)*Math.sin(lat2));
    ring.push([lng2*180/Math.PI, lat2*180/Math.PI]);
  }
  return {type:'Feature',geometry:{type:'Polygon',coordinates:[ring]}};
}





// Inicializa headers colapsables (usa aria-expanded + CSS)
function initCollapsibles(){
  document.querySelectorAll('.sec-h').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const ex = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!ex));
      // body se muestra/oculta v√≠a CSS; no hace falta tocar estilos aqu√≠
      // (opcional) persistir estado
      const key = 'uiSec:'+ (btn.id||btn.textContent.trim());
      try { localStorage.setItem(key, String(!ex)); } catch {}
    });

    // (opcional) restaurar estado
    const key = 'uiSec:'+ (btn.id||btn.textContent.trim());
    try {
      const saved = localStorage.getItem(key);
      if (saved === 'true' || saved === 'false') {
        btn.setAttribute('aria-expanded', saved);
      }
    } catch {}
  });
}

// Llama una vez cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', initCollapsibles);

</script>
</body>
</html>
